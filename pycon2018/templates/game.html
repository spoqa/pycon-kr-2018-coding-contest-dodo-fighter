{% extends "backbone_game.html" %}

{% block body %}

  <section class="section">
    <div id="gameContainer" style="width: 1280px; height: 720px; margin: auto"></div>
  </section>

  <section class="section section-game">

    <div class="current-game">
      <span class="header">현재 경기</span>
      <span class="current-game-information"></span>
    </div>

    <div class="tournament">
      <div class="header">
        <h2 class="ttile">다른 경기 보기</h2>
        <a class="btn btn-default back" href="/">메인으로 돌아가기</a>
      </div>
      <div class="status">
      </div>
    </div>

  </section>

  <script type="text/javascript">
    
    var match_set_id = {% if match_set %}'{{ match_set.id }}'{% else %}null{% endif %};
    var tournament_id = {% if tournament %}'{{ tournament.id }}'{% else %}null{% endif %};
    var undisclosed_clickable = {{ current_user.is_authenticated and current_user.moderator | tojson }};


    $(document).ready(function() {
    });
    
    document.unityPlayerReady = function() {
      if (match_set_id)
        var url = '/match_sets/' + match_set_id + '/tree';
      else
        var url = '/tournaments/' + tournament_id + '/tree';

      $.ajax({
        url: url,
        method: 'GET',
        success: function(data) {
          updateMatchTree(data.tree);
        },
        error: function(jqxhr, textStatus, errorThrown) {
          alert('서버 오류가 발생했습니다: ' + textStatus);
        }
      });
    }

    document.matchFinished = function() {
    }

    document.discloseMatch = function(uuid) {
      $.ajax({
        url: '/matches/' + uuid + '/disclose',
        method: 'POST',
        success: function(data) {
          updateMatchTree(data.tree);
        },
        error: function(jqxhr, textStatus, errorThrown) {
          alert('서버 오류가 발생했습니다: ' + textStatus);
        }
      });
    }

   function updateMatchTree(tree) {
     var $tournament = $('.tournament .status');
     $tournament.empty();

     tree.map(match => {
       var round = (match.round >= 8 ? match.round + '강' : (match.round >= 4) ? '준결승' : '결승');
       var $match = $('<div class="match"></div>');
       var $round = $('<p class="round">'+ round +'</p>');
       var $player1 = $('<p class="player">' +match.p1+ '</p>');
       var $player2 = $('<p class="player">' +match.p2+ '</p>');
       var $show = $('<button class="btn btn-default show">경기 보기</button>').click(_ => { startMatch(match.id, match.p1, match.p2, match.round) });

       $match.append($round).append($player1).append('<p>vs</p>').append($player2).append($show);

       if (undisclosed_clickable && match.p1 === '?') {
         $match.append('<button class="btn btn-danger">결과 보기</button>').click(_ => {document.discloseMatch(match.id)});
       }

       return $('<div class="status"></div>').append($match);
     }).forEach($matchEl => {
       $tournament.append($matchEl);
     });
   }

    function startMatch(uuid, p1, p2, tier) {
      $('.current-game-information').html('(' + tier + ') <span class="player">' + p1 + '</span> VS <span class="player">' + p2 + '</span>');
      gameInstance.SendMessage('Controller', 'StartMatchByUuid', uuid);
    }

  </script>

{% endblock %}
